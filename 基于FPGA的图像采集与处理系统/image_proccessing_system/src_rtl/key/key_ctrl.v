// ********************************************************************************* 
// 文件名: key_ctrl.v   
// 创建人: 梁辉鸿
// 创建日期: 2021.3.27
// 联系方式: 17hhliang3@stu.edu.cn
// --------------------------------------------------------------------------------- 
// 模块名: key_ctrl
// 发布版本号: V0.0
// --------------------------------------------------------------------------------- 
// 功能说明: 1)按键指令控制模块
//            2)生成按键指令, 寄存, 消抖
// --------------------------------------------------------------------------------- 
// 变更描述:
//    
// ---------------------------------------------------------------------------------
// 发布记录:
//  			  
// ---------------------------------------------------------------------------------
// *********************************************************************************


// ---------------------------------------------------------------------------------
// 引用文件 Include File
// --------------------------------------------------------------------------------- 

// ---------------------------------------------------------------------------------
// 仿真时间 Simulation Timescale
// ---------------------------------------------------------------------------------

// ---------------------------------------------------------------------------------
// 常量参数 Constant Parameters
// ---------------------------------------------------------------------------------

// ---------------------------------------------------------------------------------
// 模块定义 Module Define
// --------------------------------------------------------------------------------- 
module key_ctrl
(
    // clock & reset
    input 			    clk,	                //时钟信号
    input               rst_n,                  //复位信号, 低电平有效

    // input signal
    input      [ 3 : 0] key,                    //按键接口输入
    
    // output signal
    output reg [ 3 : 0] key_cmd                 //按键指令
);

// ---------------------------------------------------------------------------------
// 局部常量 Local Constant Parameters
// ---------------------------------------------------------------------------------

   
// ---------------------------------------------------------------------------------
// 模块内变量定义 Module_Variables
// --------------------------------------------------------------------------------- 
    // 按键输入的下降沿
    wire                key0_neg;
    wire                key1_neg;
    wire                key2_neg;
    wire                key3_neg;
    
    // 对按键输入的一级、二级寄存
    reg                 key0_d0;
    reg                 key0_d1;
    reg                 key1_d0;
    reg                 key1_d1;
    reg                 key2_d0;
    reg                 key2_d1;
    reg                 key3_d0;
    reg                 key3_d1;
    
// ---------------------------------------------------------------------------------
// 数据流描述 Continuous Assignments
// ---------------------------------------------------------------------------------    
    // 采集按键输入的下降沿
    assign  key0_neg = ~key0_d0 & key0_d1;
    assign  key1_neg = ~key1_d0 & key1_d1;
    assign  key2_neg = ~key2_d0 & key2_d1;
    assign  key3_neg = ~key3_d0 & key3_d1;

// ---------------------------------------------------------------------------------
// 行为描述 Clocked Assignments
// ---------------------------------------------------------------------------------
    // 寄存按键输入
    always @(posedge clk or negedge rst_n)
    begin
        if(!rst_n)
        begin
            key0_d0 <= 1'b0;
            key0_d1 <= 1'b0;
            key1_d0 <= 1'b0;
            key1_d1 <= 1'b0;
            key2_d0 <= 1'b0;
            key2_d1 <= 1'b0;
            key3_d0 <= 1'b0;
            key3_d1 <= 1'b0;
        end
        else
        begin
            key0_d0 <= key[0];
            key0_d1 <= key0_d0;
            key1_d0 <= key[1];
            key1_d1 <= key1_d0;
            key2_d0 <= key[2];
            key2_d1 <= key2_d0;
            key3_d0 <= key[3];
            key3_d1 <= key3_d0;
        end
    end

    // 产生按键输入指令
    always @(posedge clk or negedge rst_n)
    begin
        if(!rst_n)
        begin
            key_cmd <= 4'b0000;
        end
            //检测到按键按下时, 产生新的按键指令
        else if(key0_neg | key1_neg | key2_neg | key3_neg)
        begin
            key_cmd <= key;
        end
            //无按键按下时, 保持当前按键指令
        else
        begin
            key_cmd <= key_cmd;
        end
    end
    
    // 按键消抖
    
    
// ---------------------------------------------------------------------------------
// 结构化描述 Moudle Instantiate
// ---------------------------------------------------------------------------------


// ---------------------------------------------------------------------------------
// 任务定义 Called Tasks
// ---------------------------------------------------------------------------------

	
// ---------------------------------------------------------------------------------
// 函数定义 Called Functions
// ---------------------------------------------------------------------------------

    
endmodule